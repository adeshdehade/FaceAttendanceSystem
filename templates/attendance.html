<!DOCTYPE html>
<html>
<head>

<title>Live Attendance</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>

body{
    background:#f4f6f9;
    font-family:Arial;
}

.camera-card{
    background:white;
    padding:20px;
    border-radius:12px;
    box-shadow:0px 5px 15px rgba(0,0,0,0.1);
}

.attendance-box{
    background:white;
    padding:25px;
    border-radius:12px;
    box-shadow:0px 5px 15px rgba(0,0,0,0.1);
}

.video-wrapper{
    position:relative;
}

video{
    width:100%;
    border-radius:10px;
}

canvas{
    position:absolute;
    top:0;
    left:0;
}

tr:first-child{
    background:#e8f5e9;
}

</style>

</head>

<body>

<div class="container mt-4">

<h2 class="text-center mb-3">
ðŸŽ¥ Live Attendance Monitoring
</h2>

<div class="camera-card text-center">

<!-- âœ… LIVE NAME -->
<h4 id="studentName" class="text-success">
Scanning...
</h4>

<div class="video-wrapper">

<video id="video" autoplay playsinline></video>
<canvas id="overlay"></canvas>

</div>

<br>

<button class="btn btn-danger" onclick="stopCamera()">
â›” Stop Camera
</button>

<a href="/dashboard" class="btn btn-secondary">
â¬… Back Dashboard
</a>

</div>

<hr>

<div class="attendance-box">

<h4 class="text-center mb-3">
ðŸ“‹ Attendance Records
</h4>

<div class="text-center mb-3">
<a href="/reset_attendance"
class="btn btn-danger"
onclick="return confirm('Delete ALL attendance data?')">
ðŸ—‘ Reset Attendance
</a>
</div>

<div id="table"></div>

</div>

</div>


<!-- hidden capture canvas -->
<canvas id="hiddenCanvas" style="display:none;"></canvas>


<script>

let stream;
const video=document.getElementById("video");
const overlay=document.getElementById("overlay");
const ctx=overlay.getContext("2d");

/* ================= START CAMERA ================= */

navigator.mediaDevices.getUserMedia({
video:{facingMode:"environment"}
})
.then(s=>{
stream=s;
video.srcObject=s;
})
.catch(()=>{
alert("Camera Permission Required");
});

/* ================= STOP CAMERA ================= */

function stopCamera(){
if(stream){
stream.getTracks().forEach(track=>track.stop());
}
}

/* ================= SEND FRAME ================= */

setInterval(()=>{

if(!stream) return;

let canvas=document.getElementById("hiddenCanvas");

canvas.width=video.videoWidth;
canvas.height=video.videoHeight;

canvas.getContext("2d")
.drawImage(video,0,0);

fetch("/process_frame",{
method:"POST",
body:canvas.toDataURL("image/jpeg")
});

},1500);


/* ================= DRAW GREEN BOX ================= */

setInterval(()=>{

fetch("/live_face")
.then(res=>res.json())
.then(data=>{

overlay.width = video.videoWidth;
overlay.height = video.videoHeight;

ctx.clearRect(0,0,overlay.width,overlay.height);

// show name on top dashboard text
document.getElementById("studentName").innerText = data.name;

if(data.box){

let [left,top,right,bottom] = data.box;

// percentage â†’ pixel conversion
let x1 = left * overlay.width;
let y1 = top * overlay.height;

// âœ… name near detected face
ctx.fillStyle = "lime";
ctx.font = "22px Arial";
ctx.fillText(data.name, x1, y1 - 10);

}

});

},800);

/* ================= LIVE ATTENDANCE TABLE ================= */

setInterval(()=>{

fetch("/attendance_data")
.then(r=>r.text())
.then(data=>{
document.getElementById("table").innerHTML=data;
});

},2000);

</script>

</body>
</html>